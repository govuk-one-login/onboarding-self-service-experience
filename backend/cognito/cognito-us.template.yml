AWSTemplateFormatVersion: "2010-09-09"
Description: Cognito UserPool and Client for the Admin Tool
Transform: AWS::Serverless-2016-10-31

Parameters:
  ExternalId:
    Type: String
    Default: 8F4E04ED-C267-4B63-8A2C-B2B27695D727
  SecurityCodeTextMessageTemplate:
    Type: String
    Default: ac71249b-efba-4e05-911d-83648caa8dd5
  DeletionProtection:
    Type: String
    Default: INACTIVE
  DeploymentName:
    Type: String
    MaxLength: 28
    AllowedPattern: ^.*[^-]$
    Default: self-service
    Description: A unique prefix to identify the deployment; used when importing or exporting values from related stacks
  EmailSenderID:
    Type: String
    Default: GOV.UK One Login
  ProductName:
    Type: String
    Default: GOV.UK One Login admin tool
  PermissionsBoundary:
    Type: String
    Default: ""
  CodeSigningConfigArn:
    Type: String
    Default: ""

Mappings:
  Account:
    Subdomain:
      "494650018671": development.
      "399055180839": build.
      "325730373996": staging.
      "663985455444": integration.
      "389946456390": "" # production

Conditions:
  Subdomain: !Not [ !Condition TopNode ]
  TopNode: !Equals [ !FindInMap [ Account, Subdomain, !Ref AWS::AccountId ], "" ]
  UseCodeSigning: !Not [ !Equals [ !Ref CodeSigningConfigArn, "" ] ]
  UsePermissionsBoundary: !Not [ !Equals [ !Ref PermissionsBoundary, "" ] ]

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps

Resources:
  # https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html#key-policy-default-allow-root-enable-iam
  SecurityCodeEncryptionKey:
    # checkov:skip=CKV_AWS_7:Ensure rotation for customer created CMKs is enabled
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Resource: "*"
            Action: kms:*
            Principal:
              AWS: !Ref AWS::AccountId
          - Effect: Allow
            Resource: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
            Action: kms:CreateGrant
            Principal:
              Service: cognito-idp.amazonaws.com
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  SendPasswordChangedEmailFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/send-password-changed-email.handler
      Description: Send an email to confirm the user's password has been changed
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Environment:
        Variables:
          FROM_ADDRESS: !Sub [ "${EmailSenderID} <admin-tool@${emailDomain}>", { emailDomain: 'example.com' } ]
#      Policies:
#        - Version: 2012-10-17
#          Statement:
#            Effect: Allow
#            Action:
#              - ses:SendEmail
#              - ses:SendRawEmail
#            Resource: !ImportValue EmailIdentityARN
#            Condition:
#              StringEquals:
#                ses:FromAddress: !Sub [ "${EmailSenderID} <admin-tool@${emailDomain}>", { emailDomain: 'example.com' } ]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: PostConfirmation
            UserPool: !Ref UserPool

  CreatePasswordResetMessageFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/create-password-reset-message.handler
      Description: Create a customised email message to send when resetting the user's password
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: CustomMessage
            UserPool: !Ref UserPool

  SecurityCodeTextMessageSender:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/security-code-text-message-sender.lambdaHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      MemorySize: 1024
      Environment:
        Variables:
          NOTIFY_API_KEY: "api-key-01"
          SECURITY_CODE_TEXT_MESSAGE_TEMPLATE: !Ref SecurityCodeTextMessageTemplate
          DECRYPTION_KEY_ARN: !GetAtt SecurityCodeEncryptionKey.Arn
      Policies:
        Statement:
          Effect: Allow
          Action: kms:Decrypt
          Resource: !GetAtt SecurityCodeEncryptionKey.Arn

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Ref DeploymentName
      DeletionProtection: !Ref DeletionProtection
      Policies:
        PasswordPolicy:
          MinimumLength: 6
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          TemporaryPasswordValidityDays: 7
      Schema:
        - Name: sub
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: false
          Required: true
          StringAttributeConstraints:
            MinLength: 1
            MaxLength: 2048
        - Name: email
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
        - Name: phone_number
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
      AutoVerifiedAttributes: [ email ]
      UsernameAttributes: [ email ]
      EmailVerificationMessage: !Sub |-
        <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
            <title>Your security code for the ${ProductName}</title>
            <style>
              body {
                -webkit-font-smoothing: antialiased;
                margin: 0;
                padding: 0;
                -ms-text-size-adjust: 100%;
                -webkit-text-size-adjust: 100%;
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
              }

              .bold-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .normal-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 400;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .body {
                background-color: #white;
                width: 100%;
              }

              .wrapper {
                box-sizing: border-box;
                padding: 10px;
              }
            </style>
          </head>
          <body>
            <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
              <!--MAIN CONTENT AREA -->
              <tr>
                <td class="wrapper">
                  <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                      <td>
                        <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                          <tbody>
                            <tr>
                              <td width="100%" height="53" bgcolor="#0b0c0c">
                                <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                  <tbody>
                                    <tr>
                                      <td width="70" bgcolor="#0b0c0c" valign="middle">
                                        <a href="https://www.gov.uk" title="Go to the GOV.UK homepage" style="text-decoration:none" target="_blank" data-saferedirecturl="https://www.google.com/url?q=https://www.gov.uk&amp;source=gmail&amp;ust=1655759894745000&amp;usg=AOvVaw3YX7ZnOa7uia318p4Azv4u">
                                          <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                            <tbody>
                                              <tr>
                                                <td style="padding-left:10px">
                                                  <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                </td>
                                                <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                  <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                  <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                          -moz-osx-font-smoothing: grayscale;
                          display: inline-table;
                          font-style: normal;
                          font-weight: 400;
                          font-size: 24px;
                          line-height: 32px;
                          color: white;
                          "> One Login admin tool <strong style="display: inline-block;
                              outline: 2px solid transparent;
                              outline-offset: -2px;
                              color: #ffffff;
                              background-color: #1d70b8;
                              letter-spacing: 1px;
                              text-decoration: none;
                              text-transform: uppercase;
                              font-family: arial, sans-serif;
                              -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              padding-top: 5px;
                              padding-right: 8px;
                              padding-bottom: 4px;
                              padding-left: 8px;
                              font-style: normal;
                              font-weight: 700;
                              font-size: 16px;
                              line-height: 16px;
                              letter-spacing: 1px;
                              text-transform: uppercase;"> beta </strong>
                                                  </span>
                                                </td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </a>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <div style="margin-top: 40px;"></div>
                        <p class="normal-text">Your security code is: </p>
                        <p class="bold-text">{####}</p>
                        <p class="normal-text">The code will expire after 15 minutes.</p>
                        <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                        <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
        </html>
      EmailVerificationSubject: !Sub Your security code for the ${ProductName}
      VerificationMessageTemplate:
        EmailMessage: !Sub |-
          <html>
            <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
              <title>Your security code for the ${ProductName}</title>
              <style>
                body {
                  -webkit-font-smoothing: antialiased;
                  margin: 0;
                  padding: 0;
                  -ms-text-size-adjust: 100%;
                  -webkit-text-size-adjust: 100%;
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                }

                .bold-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .normal-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 400;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .body {
                  background-color: #white;
                  width: 100%;
                }

                .wrapper {
                  box-sizing: border-box;
                  padding: 10px;
                }
              </style>
            </head>
            <body>
              <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                <!--MAIN CONTENT AREA -->
                <tr>
                  <td class="wrapper">
                    <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <td>
                          <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                            <tbody>
                              <tr>
                                <td width="100%" height="53" bgcolor="#0b0c0c">
                                  <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                    <tbody>
                                      <tr>
                                        <td width="70" bgcolor="#0b0c0c" valign="middle">
                                          <a href="https://www.gov.uk" title="Go to the GOV.UK homepage" style="text-decoration:none" target="_blank" data-saferedirecturl="https://www.google.com/url?q=https://www.gov.uk&amp;source=gmail&amp;ust=1655759894745000&amp;usg=AOvVaw3YX7ZnOa7uia318p4Azv4u">
                                            <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                              <tbody>
                                                <tr>
                                                  <td style="padding-left:10px">
                                                    <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                  </td>
                                                  <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                    <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                    <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                            display: inline-table;
                            font-style: normal;
                            font-weight: 400;
                            font-size: 24px;
                            line-height: 32px;
                            color: white;
                            "> One Login admin tool <strong style="display: inline-block;
                                outline: 2px solid transparent;
                                outline-offset: -2px;
                                color: #ffffff;
                                background-color: #1d70b8;
                                letter-spacing: 1px;
                                text-decoration: none;
                                text-transform: uppercase;
                                font-family: arial, sans-serif;
                                -webkit-font-smoothing: antialiased;
                                -moz-osx-font-smoothing: grayscale;
                                padding-top: 5px;
                                padding-right: 8px;
                                padding-bottom: 4px;
                                padding-left: 8px;
                                font-style: normal;
                                font-weight: 700;
                                font-size: 16px;
                                line-height: 16px;
                                letter-spacing: 1px;
                                text-transform: uppercase;"> beta </strong>
                                                    </span>
                                                  </td>
                                                </tr>
                                              </tbody>
                                            </table>
                                          </a>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                          <div style="margin-top: 40px;"></div>
                          <p class="normal-text">Your security code is: </p>
                          <p class="bold-text">{####}</p>
                          <p class="normal-text">The code will expire after 15 minutes.</p>
                          <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                          <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
          </html>
        EmailSubject: !Sub Your security code for the ${ProductName}
        DefaultEmailOption: CONFIRM_WITH_CODE
      MfaConfiguration: OPTIONAL
      EnabledMfas: [ SMS_MFA ]
      SmsConfiguration:
        SnsCallerArn: !GetAtt SmsRole.Arn
        ExternalId: !Ref ExternalId
        SnsRegion: !Ref AWS::Region
#      EmailConfiguration:
#        EmailSendingAccount: DEVELOPER
#        SourceArn: !ImportValue EmailIdentityARN
#        From: !Sub [ "${EmailSenderID} <admin-tool@${emailDomain}>", { emailDomain: !ImportValue EmailDomain } ]
      # https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-sms-settings.html
      LambdaConfig:
        CustomSMSSender:
          LambdaArn: !GetAtt SecurityCodeTextMessageSender.Arn
          LambdaVersion: V1_0
        KMSKeyID: !GetAtt SecurityCodeEncryptionKey.Arn
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
        InviteMessageTemplate:
          EmailMessage: !Sub |-
            <html>
              <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                <title>Your security code for the ${ProductName}</title>
                <style>
                  body {
                    -webkit-font-smoothing: antialiased;
                    margin: 0;
                    padding: 0;
                    -ms-text-size-adjust: 100%;
                    -webkit-text-size-adjust: 100%;
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                  }

                  .bold-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .normal-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 400;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .body {
                    background-color: #white;
                    width: 100%;
                  }

                  .wrapper {
                    box-sizing: border-box;
                    padding: 10px;
                  }
                </style>
              </head>
              <body>
                <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                  <!--MAIN CONTENT AREA -->
                  <tr>
                    <td class="wrapper">
                      <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                          <td>
                            <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                              <tbody>
                                <tr>
                                  <td width="830px" height="53" bgcolor="#0b0c0c">
                                    <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                      <tbody>
                                        <tr>
                                          <td width="70" bgcolor="#0b0c0c" valign="middle">
                                            <a style="text-decoration:none;pointer-events: none;cursor: default;">
                                              <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                                <tbody>
                                                  <tr>
                                                    <td style="padding-left:10px">
                                                      <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                    </td>
                                                    <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                      <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                      <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              display: inline-table;
                              font-style: normal;
                              font-weight: 400;
                              font-size: 24px;
                              line-height: 32px;
                              color: white;
                              "> One Login admin tool <strong style="display: inline-block;
                                  outline: 2px solid transparent;
                                  outline-offset: -2px;
                                  color: #ffffff;
                                  background-color: #1d70b8;
                                  letter-spacing: 1px;
                                  text-decoration: none;
                                  text-transform: uppercase;
                                  font-family: arial, sans-serif;
                                  -webkit-font-smoothing: antialiased;
                                  -moz-osx-font-smoothing: grayscale;
                                  padding-top: 5px;
                                  padding-right: 8px;
                                  padding-bottom: 4px;
                                  padding-left: 8px;
                                  font-style: normal;
                                  font-weight: 700;
                                  font-size: 16px;
                                  line-height: 16px;
                                  letter-spacing: 1px;
                                  text-transform: uppercase;"> beta </strong>
                                                      </span>
                                                    </td>
                                                  </tr>
                                                </tbody>
                                              </table>
                                            </a>
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                            <div style="margin-top: 40px;"></div>
                            <p class="normal-text">Your security code is: </p>
                            <p class="bold-text">{####}</p>
                            <p class="normal-text">The code will expire after 15 minutes.</p>
                            <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                            <p class="normal-text"> <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">{username} </a></p>
                            <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                          </span>
                        </tr>
                      </table>
                    </td>
                        </tr>
                      </table>
              </body>
            </html>
          EmailSubject: !Sub Your security code for the ${ProductName}
      UsernameConfiguration:
        CaseSensitive: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Priority: 1
            Name: verified_email

  # https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-sms-settings.html
  SmsRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service: cognito-idp.amazonaws.com
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalId
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*
      Policies:
        - PolicyName: SnsPublish
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Effect: Allow
              Action: sns:publish
              Resource: "*"

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  CognitoInvokeSecurityCodeTextMessageSenderPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SecurityCodeTextMessageSender
      Principal: cognito-idp.amazonaws.com

  SubdomainHostedZoneShieldProtection:
    Type: AWS::Shield::Protection
    Condition: Subdomain
    Properties:
      Name: 'SubdomainHostedZoneShieldProtection'
      ResourceArn: arn:aws:route53:::hostedzone/Z03674982M87OQKN51BWI

  ApexHostedZoneShieldProtection:
    Type: AWS::Shield::Protection
    Condition: TopNode
    Properties:
      Name: 'ApexHostedZoneShieldProtection'
      ResourceArn: arn:aws:route53:::hostedzone/Z03674982M87OQKN51BWI

#  AlbShieldProtectionWebACL:
#    Type: 'AWS::WAFv2::WebACL'
#    Properties:
#      Name: AlbShieldProtectionWebACL
#      Scope: REGIONAL
#      Description: This is WebACL to protect ALB
#      DefaultAction:
#        Allow: {}
#      VisibilityConfig:
#        SampledRequestsEnabled: true
#        CloudWatchMetricsEnabled: true
#        MetricName: AlbShieldProtectionWebACLMetric
#      Rules:
#        - Name: AlbRuleWithRateLimit
#          Priority: 0
#          Action:
#            Block: {}
#          VisibilityConfig:
#            SampledRequestsEnabled: true
#            CloudWatchMetricsEnabled: true
#            MetricName: RuleWithAlbShieldProtectionWebACLMetric
#          Statement:
#            RateBasedStatement:
#              AggregateKeyType: IP
#              Limit: 1000
#        # This rule fixes CKV_AWS_192: "Ensure WAF prevents message lookup in Log4j2. See CVE-2021-44228 aka log4jshell"
#        - Name: AWS-AWSManagedRulesKnownBadInputsRuleSet
#          Priority: 1
#          Statement:
#            ManagedRuleGroupStatement:
#              VendorName: AWS
#              Name: AWSManagedRulesKnownBadInputsRuleSet
#          OverrideAction:
#            None: {}
#          VisibilityConfig:
#            SampledRequestsEnabled: true
#            CloudWatchMetricsEnabled: true
#            MetricName: RuleWithAlbShieldProtectionWebACLBadInputMetric
#
#  AlbShieldProtectionWebACLAssociation:
#    Type: 'AWS::WAFv2::WebACLAssociation'
#    Properties:
#      WebACLArn: !GetAtt AlbShieldProtectionWebACL.Arn
#      ResourceArn: arn:aws:elasticloadbalancing:eu-west-2:494650018671:loadbalancer/app/test-admin-tool-frontend/512489fbdbf998b5
#
#  AlbShieldProtection:
#    Type: AWS::Shield::Protection
#    DependsOn: AlbShieldProtectionWebACLAssociation
#    Properties:
#      Name: 'AlbShieldProtection'
#      ResourceArn: arn:aws:elasticloadbalancing:eu-west-2:494650018671:loadbalancer/app/test-admin-tool-frontend/512489fbdbf998b5
#      ApplicationLayerAutomaticResponseConfiguration:
#        Status: ENABLED
#        Action:
#          Block: { }

  NatGatewayZoneAEIPShieldProtection:
    Type: AWS::Shield::Protection
    Properties:
      Name: 'NatGatewayZoneAEIPShieldProtection'
      ResourceArn: arn:aws:ec2:eu-west-2:494650018671:eip-allocation/eipalloc-0133898bcfb9dd11c

  NatGatewayZoneBEIPShieldProtection:
    Type: AWS::Shield::Protection
    Properties:
      Name: 'NatGatewayZoneBEIPShieldProtection'
      ResourceArn: arn:aws:ec2:eu-west-2:494650018671:eip-allocation/eipalloc-008d4d53f8af10be6

  CloudFrontShieldProtectionWebACL:
    Type: 'AWS::WAFv2::WebACL'
    Properties:
      Name: CloudFrontShieldProtectionWebACL
      Scope: CLOUDFRONT
      Description: This is WebACL to protect CloudFront
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: CloudFrontShieldProtectionWebACLMetric
      Rules:
        - Name: CloudFrontRuleWithRateLimit
          Priority: 0
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RuleWithCloudFrontShieldProtectionWebACLMetric
          Statement:
            RateBasedStatement:
              AggregateKeyType: IP
              Limit: 1000
        # This rule fixes CKV_AWS_192: "Ensure WAF prevents message lookup in Log4j2. See CVE-2021-44228 aka log4jshell"
        - Name: AWS-AWSManagedRulesKnownBadInputsRuleSet
          Priority: 1
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RuleWithAlbShieldProtectionWebACLBadInputMetric

#  CloudFrontShieldProtectionWebACLAssociation:
#    Type: 'AWS::WAFv2::WebACLAssociation'
#    Properties:
#      WebACLArn: !GetAtt CloudFrontShieldProtectionWebACL.Arn
#      ResourceArn: arn:aws:cloudfront::494650018671:distribution/E3TEKHJ0PG2YFU

  CloudFrontShieldProtection:
    Type: AWS::Shield::Protection
    Properties:
      Name: 'CloudFrontShieldProtection'
      ResourceArn: arn:aws:cloudfront::494650018671:distribution/E3TEKHJ0PG2YFU
      ApplicationLayerAutomaticResponseConfiguration:
        Status: ENABLED
        Action:
          Block: { }

Outputs:
  UserPoolID:
    Value: !Ref UserPool
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolID
  UserPoolARN:
    Value: !GetAtt UserPool.Arn
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolARN
  UserPoolClientID:
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolClientID
