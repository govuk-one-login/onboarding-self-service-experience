AWSTemplateFormatVersion: "2010-09-09"
Description: Cognito UserPool and Client for the Admin Tool
Transform: AWS::Serverless-2016-10-31

Parameters:
  DeletionProtection:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/config/deletion-protection-enabled
  ExportNamePrefix:
    Type: String
    Default: self-service
    AllowedPattern: ^.*[^-]$
    Description: Prefix to use when importing or exporting values from other application stacks
  CodeSigningConfigArn:
    Type: String
    Default: ""
    Description: The ARN of the code signing configuration to use for lambdas [Secure Pipelines]
  PermissionsBoundary:
    Type: String
    Default: ""
    Description: The ARN of the permissions boundary to apply when creating IAM roles [Secure Pipelines]
  SecurityCodeTextMessageTemplate:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/cognito/security-code-text-message-template

Conditions:
  UseCodeSigning: !Not [ !Equals [ !Ref CodeSigningConfigArn, "" ] ]
  UsePermissionsBoundary: !Not [ !Equals [ !Ref PermissionsBoundary, "" ] ]

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps

Resources:
  SecurityCodeEncryptionKey:
    # checkov:skip=CKV_AWS_7: "Ensure rotation for customer created CMKs is enabled"
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: cognito-idp.amazonaws.com
            Action: kms:CreateGrant
            Resource: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  SendPasswordChangedEmailFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/send-password-changed-email.handler
      Description: Send an email to confirm the user's password has been changed
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Environment:
        Variables:
          FROM_ADDRESS: !Sub [ "admin-tool@${emailDomain}", { emailDomain: !ImportValue EmailDomain } ]
      Policies:
        - Version: 2012-10-17
          Statement:
            Effect: Allow
            Action:
              - ses:SendEmail
              - ses:SendRawEmail
            Resource: !ImportValue EmailIdentityARN
            Condition:
              StringEquals:
                ses:FromAddress: !Sub [ "admin-tool@${emailDomain}", { emailDomain: !ImportValue EmailDomain } ]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: PostConfirmation
            UserPool: !Ref UserPool

  CreatePasswordResetMessageFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/create-password-reset-message.handler
      Description: Create a customised email message to send when resetting the user's password
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: CustomMessage
            UserPool: !Ref UserPool

  SecurityCodeTextMessageSender:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: src/handlers/security-code-text-message-sender.lambdaHandler
      Environment:
        Variables:
          NOTIFY_API_KEY: "{{resolve:secretsmanager:/self-service/cognito/notify-api-key:SecretString}}"
          SECURITY_CODE_TEXT_MESSAGE_TEMPLATE: !Ref SecurityCodeTextMessageTemplate
          KEY_ARN: !GetAtt SecurityCodeEncryptionKey.Arn
      MemorySize: 1024
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
      Policies:
        Statement:
            Effect: Allow
            Action: kms:Decrypt
            Resource: !GetAtt SecurityCodeEncryptionKey.Arn

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      DeletionProtection: !Ref DeletionProtection
      Policies:
        PasswordPolicy:
          MinimumLength: 6
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          TemporaryPasswordValidityDays: 7
      Schema:
        - Name: sub
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: false
          Required: true
          StringAttributeConstraints:
            MinLength: 1
            MaxLength: 2048
        - Name: email
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
        - Name: phone_number
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
      AutoVerifiedAttributes: [ email ]
      UsernameAttributes: [ email ]
      EmailVerificationMessage: |-
        <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
            <title>Your security code for the GOV.UK One Login admin tool</title>
            <style>
              body {
                -webkit-font-smoothing: antialiased;
                margin: 0;
                padding: 0;
                -ms-text-size-adjust: 100%;
                -webkit-text-size-adjust: 100%;
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
              }

              .bold-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .normal-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 400;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .body {
                background-color: #white;
                width: 100%;
              }

              .wrapper {
                box-sizing: border-box;
                padding: 10px;
              }
            </style>
          </head>
          <body>
            <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
              <!--MAIN CONTENT AREA -->
              <tr>
                <td class="wrapper">
                  <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                      <td>
                        <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                          <tbody>
                            <tr>
                              <td width="100%" height="53" bgcolor="#0b0c0c">
                                <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                  <tbody>
                                    <tr>
                                      <td width="70" bgcolor="#0b0c0c" valign="middle">
                                        <a href="https://www.gov.uk" title="Go to the GOV.UK homepage" style="text-decoration:none" target="_blank" data-saferedirecturl="https://www.google.com/url?q=https://www.gov.uk&amp;source=gmail&amp;ust=1655759894745000&amp;usg=AOvVaw3YX7ZnOa7uia318p4Azv4u">
                                          <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                            <tbody>
                                              <tr>
                                                <td style="padding-left:10px">
                                                  <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                </td>
                                                <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                  <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                  <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                          -moz-osx-font-smoothing: grayscale;
                          display: inline-table;
                          font-style: normal;
                          font-weight: 400;
                          font-size: 24px;
                          line-height: 32px;
                          color: white;
                          "> One Login admin tool <strong style="display: inline-block;
                              outline: 2px solid transparent;
                              outline-offset: -2px;
                              color: #ffffff;
                              background-color: #1d70b8;
                              letter-spacing: 1px;
                              text-decoration: none;
                              text-transform: uppercase;
                              font-family: arial, sans-serif;
                              -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              padding-top: 5px;
                              padding-right: 8px;
                              padding-bottom: 4px;
                              padding-left: 8px;
                              font-style: normal;
                              font-weight: 700;
                              font-size: 16px;
                              line-height: 16px;
                              letter-spacing: 1px;
                              text-transform: uppercase;"> beta </strong>
                                                  </span>
                                                </td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </a>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <div style="margin-top: 40px;"></div>
                        <p class="normal-text">Your security code is: </p>
                        <p class="bold-text">{####}</p>
                        <p class="normal-text">The code will expire after 15 minutes.</p>
                        <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                        <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
        </html>
      EmailVerificationSubject: Your security code for the GOV.UK One Login Admin Tool
      VerificationMessageTemplate:
        EmailMessage: |-
          <html>
            <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
              <title>Your security code for the GOV.UK One Login Admin Tool</title>
              <style>
                body {
                  -webkit-font-smoothing: antialiased;
                  margin: 0;
                  padding: 0;
                  -ms-text-size-adjust: 100%;
                  -webkit-text-size-adjust: 100%;
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                }

                .bold-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .normal-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 400;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .body {
                  background-color: #white;
                  width: 100%;
                }

                .wrapper {
                  box-sizing: border-box;
                  padding: 10px;
                }
              </style>
            </head>
            <body>
              <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                <!--MAIN CONTENT AREA -->
                <tr>
                  <td class="wrapper">
                    <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <td>
                          <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                            <tbody>
                              <tr>
                                <td width="100%" height="53" bgcolor="#0b0c0c">
                                  <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                    <tbody>
                                      <tr>
                                        <td width="70" bgcolor="#0b0c0c" valign="middle">
                                          <a href="https://www.gov.uk" title="Go to the GOV.UK homepage" style="text-decoration:none" target="_blank" data-saferedirecturl="https://www.google.com/url?q=https://www.gov.uk&amp;source=gmail&amp;ust=1655759894745000&amp;usg=AOvVaw3YX7ZnOa7uia318p4Azv4u">
                                            <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                              <tbody>
                                                <tr>
                                                  <td style="padding-left:10px">
                                                    <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                  </td>
                                                  <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                    <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                    <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                            display: inline-table;
                            font-style: normal;
                            font-weight: 400;
                            font-size: 24px;
                            line-height: 32px;
                            color: white;
                            "> One Login Admin Tool <strong style="display: inline-block;
                                outline: 2px solid transparent;
                                outline-offset: -2px;
                                color: #ffffff;
                                background-color: #1d70b8;
                                letter-spacing: 1px;
                                text-decoration: none;
                                text-transform: uppercase;
                                font-family: arial, sans-serif;
                                -webkit-font-smoothing: antialiased;
                                -moz-osx-font-smoothing: grayscale;
                                padding-top: 5px;
                                padding-right: 8px;
                                padding-bottom: 4px;
                                padding-left: 8px;
                                font-style: normal;
                                font-weight: 700;
                                font-size: 16px;
                                line-height: 16px;
                                letter-spacing: 1px;
                                text-transform: uppercase;"> beta </strong>
                                                    </span>
                                                  </td>
                                                </tr>
                                              </tbody>
                                            </table>
                                          </a>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                          <div style="margin-top: 40px;"></div>
                          <p class="normal-text">Your security code is: </p>
                          <p class="bold-text">{####}</p>
                          <p class="normal-text">The code will expire after 15 minutes.</p>
                          <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                          <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
          </html>
        EmailSubject: Your security code for the GOV.UK One Login Admin Tool
        DefaultEmailOption: CONFIRM_WITH_CODE
      MfaConfiguration: "OFF"
      EmailConfiguration:
        EmailSendingAccount: DEVELOPER
        SourceArn: !ImportValue EmailIdentityARN
        From: !Sub [ "admin-tool@${emailDomain}", { emailDomain: !ImportValue EmailDomain } ]
      # https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-sms-settings.html
      LambdaConfig:
        CustomSMSSender:
          LambdaArn: !GetAtt SecurityCodeTextMessageSender.Arn
          LambdaVersion: V1_0
        KMSKeyID: !GetAtt SecurityCodeEncryptionKey.Arn
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
        InviteMessageTemplate:
          EmailMessage: |-
            <html>
              <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                <title>Your security code for the GOV.UK One Login Admin Tool</title>
                <style>
                  body {
                    -webkit-font-smoothing: antialiased;
                    margin: 0;
                    padding: 0;
                    -ms-text-size-adjust: 100%;
                    -webkit-text-size-adjust: 100%;
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                  }

                  .bold-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .normal-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 400;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .body {
                    background-color: #white;
                    width: 100%;
                  }

                  .wrapper {
                    box-sizing: border-box;
                    padding: 10px;
                  }
                </style>
              </head>
              <body>
                <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                  <!--MAIN CONTENT AREA -->
                  <tr>
                    <td class="wrapper">
                      <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                          <td>
                            <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                              <tbody>
                                <tr>
                                  <td width="830px" height="53" bgcolor="#0b0c0c">
                                    <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                      <tbody>
                                        <tr>
                                          <td width="70" bgcolor="#0b0c0c" valign="middle">
                                            <a style="text-decoration:none;pointer-events: none;cursor: default;">
                                              <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                                <tbody>
                                                  <tr>
                                                    <td style="padding-left:10px">
                                                      <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                    </td>
                                                    <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                      <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                      <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              display: inline-table;
                              font-style: normal;
                              font-weight: 400;
                              font-size: 24px;
                              line-height: 32px;
                              color: white;
                              "> One Login Admin Tool <strong style="display: inline-block;
                                  outline: 2px solid transparent;
                                  outline-offset: -2px;
                                  color: #ffffff;
                                  background-color: #1d70b8;
                                  letter-spacing: 1px;
                                  text-decoration: none;
                                  text-transform: uppercase;
                                  font-family: arial, sans-serif;
                                  -webkit-font-smoothing: antialiased;
                                  -moz-osx-font-smoothing: grayscale;
                                  padding-top: 5px;
                                  padding-right: 8px;
                                  padding-bottom: 4px;
                                  padding-left: 8px;
                                  font-style: normal;
                                  font-weight: 700;
                                  font-size: 16px;
                                  line-height: 16px;
                                  letter-spacing: 1px;
                                  text-transform: uppercase;"> beta </strong>
                                                      </span>
                                                    </td>
                                                  </tr>
                                                </tbody>
                                              </table>
                                            </a>
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                            <div style="margin-top: 40px;"></div>
                            <p class="normal-text">Your security code is: </p>
                            <p class="bold-text">{####}</p>
                            <p class="normal-text">The code will expire after 15 minutes.</p>
                            <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                            <p class="normal-text"> <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">{username} </a></p>
                            <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                          </span>
                        </tr>
                      </table>
                    </td>
                        </tr>
                      </table>
              </body>
            </html>
          EmailSubject: Your security code for the GOV.UK One Login Admin Tool
      UsernameConfiguration:
        CaseSensitive: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Priority: 1
            Name: verified_email

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH


  CognitoInvokeSecurityCodeTextMessageSenderPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SecurityCodeTextMessageSender
      Principal: "cognito-idp.amazonaws.com"

Outputs:
  UserPoolName:
    Value: !Ref UserPool
    Export:
      Name: !Sub ${ExportNamePrefix}-CognitoUserPoolID
  UserPoolClientId:
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${ExportNamePrefix}-CognitoUserPoolClientID
