AWSTemplateFormatVersion: "2010-09-09"
Description: Cognito UserPool and Client for the Admin Tool | v1.0.0
Transform: AWS::Serverless-2016-10-31

Parameters:
  Environment:
    Description: "The name of the environment to deploy to."
    Type: "String"
    Default: local
    AllowedValues:
      - "local"
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
  DeploymentName:
    Type: String
    MaxLength: 22
    AllowedPattern: ^.*[^-]$
    Default: self-service
    Description: A unique prefix to identify the deployment; used to distinguish variation between ephemeral stacks
  ExternalId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/cognito/external-id
  SecurityCodeTextMessageTemplate:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/cognito/security-code-text-message-template
  DeletionProtection:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/config/deletion-protection-enabled
  EmailSenderID:
    Type: String
    Default: GOV.UK One Login
  ProductName:
    Type: String
    Default: GOV.UK One Login admin tool
  PermissionsBoundary:
    Type: String
    Default: ""
  CodeSigningConfigArn:
    Type: String
    Default: ""

Rules:
  DeploymentNameRequired:
    RuleCondition: !Equals [ !Ref Environment, "local" ]
    Assertions:
      - Assert: !Not [ !Equals [ !Ref DeploymentName, "" ] ]
        AssertDescription: >
          Must specify DeploymentName parameter when Environment is "local"

  DeploymentNameMustBeEmpty:
    RuleCondition: !Not [ !Equals [ !Ref Environment, "local" ] ]
    Assertions:
      - Assert: !Equals [ !Ref DeploymentName, "self-service" ] # Confirm the default value is used.
        AssertDescription: >
          Must not specify DeploymentName parameter when Environment is not "local"

Mappings:
  EnvironmentConfiguration:
    local:
      dynatraceLoggingEnabled: false # Local builds do not support dynatrace
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    dev:
      dynatraceLoggingEnabled: true
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    build:
      dynatraceLoggingEnabled: true
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    staging:
      dynatraceLoggingEnabled: true
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    integration:
      dynatraceLoggingEnabled: true
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    production:
      dynatraceLoggingEnabled: true
      cslsLoggingEnabled: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
      clslSubscriptionFilterArn: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
  WafArn:
    Environment:
      local: "/self-service/development/waf-web-acl"
      dev: "/self-service/development/waf-web-acl"
      build: "/self-service/build/waf-web-acl"
      staging: "/self-service/staging/waf-web-acl"
      integration: "/self-service/integration/waf-web-acl"
      production: "/self-service/production/waf-web-acl"

Conditions:
  UseCodeSigning: !Not [ !Equals [ !Ref CodeSigningConfigArn, "" ] ]
  UsePermissionsBoundary: !Not [ !Equals [ !Ref PermissionsBoundary, "" ] ]
  DynatraceLoggingEnabled: !Equals [ !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceLoggingEnabled ], true ]
  CslsLoggingEnabled: !Equals [ !FindInMap [ EnvironmentConfiguration, !Ref Environment, cslsLoggingEnabled ], true ]
  IsLocal: !Equals [ !Ref Environment, "local" ]

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs20.x
    PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
    VpcConfig:
      SecurityGroupIds: [ !ImportValue VPC-VPCEndpointsSecurityGroup ]
      SubnetIds: !Split [ ",", !ImportValue VPC-PrivateSubnets ]
    LoggingConfig:
      ApplicationLogLevel: INFO
      LogFormat: JSON
      LogGroup: !Ref LambdaLogsGroup
      SystemLogLevel: INFO
    CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
    Layers:
      - !If
        - DynatraceLoggingEnabled
        - !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}'
          - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
        - !Ref AWS::NoValue
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        AWS_LAMBDA_EXEC_WRAPPER: !If [ DynatraceLoggingEnabled, "/opt/dynatrace", !Ref "AWS::NoValue" ]
        DT_CONNECTION_AUTH_TOKEN: !If
          - DynatraceLoggingEnabled
          - !Sub
            - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}'
            - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
          - !Ref "AWS::NoValue"
        DT_CONNECTION_BASE_URL: !If
          - DynatraceLoggingEnabled
          - !Sub
            - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}'
            - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
          - !Ref "AWS::NoValue"
        DT_CLUSTER_ID: !If
          - DynatraceLoggingEnabled
          - !Sub
            - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}'
            - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
          - !Ref "AWS::NoValue"
        DT_LOG_COLLECTION_AUTH_TOKEN: !If
          - DynatraceLoggingEnabled
          - !Sub
            - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}'
            - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
          - !Ref "AWS::NoValue"
        DT_TENANT: !If
          - DynatraceLoggingEnabled
          - !Sub
            - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}'
            - SecretArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, dynatraceSecretArn ]
          - !Ref "AWS::NoValue"
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: !If [DynatraceLoggingEnabled, "true", !Ref "AWS::NoValue"]

Resources:
  # https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html#key-policy-default-allow-root-enable-iam
  SecurityCodeEncryptionKey:
    # checkov:skip=CKV_AWS_7:Ensure rotation for customer created CMKs is enabled
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Resource: "*"
            Action: kms:*
            Principal:
              AWS: !Ref AWS::AccountId
          - Effect: Allow
            Resource: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
            Action: kms:CreateGrant
            Principal:
              Service: cognito-idp.amazonaws.com
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*

  EnvironmentVariablesEncryptionKey:
    # checkov:skip=CKV_AWS_7:Ensure rotation for customer created CMKs is enabled
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Resource: "*"
            Action: kms:*
            Principal:
              AWS: !Ref AWS::AccountId
          - Effect: Allow
            Resource: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
            Action:
              - kms:ListAliases
              - kms:CreateGrant
              - kms:Encrypt
              - kms:Decrypt
            Principal:
              Service: lambda.amazonaws.com
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function/*

  LogAuditLogGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - "/"
        - - '/onboarding-self-service/cognito'
          - !If [ IsLocal, !Ref DeploymentName, !Ref AWS::NoValue ]
          - 'audit'
      RetentionInDays: 30

  LambdaLogsGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - "/"
        - - '/aws/lambda'
          - 'onboarding-self-service/cognito'
          - !If [ IsLocal, !Ref DeploymentName, !Ref AWS::NoValue ]
          - 'all'
      RetentionInDays: 30
      DataProtectionPolicy:
        Name: data-protection-policy-cognito-lambda
        Description: Data Protection for Cloudwatch Logs
        Version: '2021-06-01'
        Statement:
          - Sid: audit-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Audit:
                FindingsDestination:
                  CloudWatchLogs:
                    LogGroup: !Ref LogAuditLogGroup
          - Sid: redact-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Deidentify:
                MaskConfig: { }

  LambdaLogCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsLoggingEnabled
    Properties:
      LogGroupName: !Ref LambdaLogsGroup
      FilterName: "Lambda logs for Cognito"
      FilterPattern: ""
      DestinationArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, clslSubscriptionFilterArn ]

  SendPasswordChangedEmailFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        External:
          - "@aws-sdk/*" # AWS SDK v3 dependencies are already included in the lambda runtime
    Properties:
      Handler: src/handlers/send-password-changed-email.handler
      Description: Send an email to confirm the user's password has been changed
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - !If [DynatraceLoggingEnabled, !Ref DynatraceSecretsAccessPolicy, !Ref "AWS::NoValue"]
        - Version: 2012-10-17
          Statement:
            Effect: Allow
            Action:
              - ses:SendEmail
              - ses:SendRawEmail
            Resource: !ImportValue DNS-EmailIdentityARN
            Condition:
              StringEquals:
                ses:FromAddress: !Sub [ "${EmailSenderID} <${DeploymentName}@${Domain}>", { Domain: !ImportValue DNS-Domain } ]
      Environment:
        Variables:
          FROM_ADDRESS: !Sub [ "${EmailSenderID} <${DeploymentName}@${Domain}>", { Domain: !ImportValue DNS-Domain } ]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: PostConfirmation
            UserPool: !Ref UserPool

  CreatePasswordResetMessageFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        External:
          - "@aws-sdk/*" # AWS SDK v3 dependencies are already included in the lambda runtime
    Properties:
      Handler: src/handlers/create-password-reset-message.handler
      Description: Create a customised email message to send when resetting the user's password
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - !If [DynatraceLoggingEnabled, !Ref DynatraceSecretsAccessPolicy, !Ref "AWS::NoValue"]
      Events:
        Cognito:
          Type: Cognito
          Properties:
            Trigger: CustomMessage
            UserPool: !Ref UserPool

  SendSecurityCodeTextMessageFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        External:
          - "@aws-sdk/*" # AWS SDK v3 dependencies are already included in the lambda runtime
    Properties:
      Handler: src/handlers/send-security-code-text-message.lambdaHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      MemorySize: 1024
      VpcConfig:
        SubnetIds: !Split [ ",", !ImportValue VPC-ProtectedSubnets ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - !If [DynatraceLoggingEnabled, !Ref DynatraceSecretsAccessPolicy, !Ref "AWS::NoValue"]
        - Version: 2012-10-17
          Statement:
            Effect: Allow
            Action: kms:Decrypt
            Resource: !GetAtt SecurityCodeEncryptionKey.Arn
      Environment:
        Variables:
          NOTIFY_API_KEY: "{{resolve:secretsmanager:/self-service/cognito/notify-api-key}}"
          SECURITY_CODE_TEXT_MESSAGE_TEMPLATE: !Ref SecurityCodeTextMessageTemplate
          DECRYPTION_KEY_ARN: !GetAtt SecurityCodeEncryptionKey.Arn
      KmsKeyArn: !GetAtt EnvironmentVariablesEncryptionKey.Arn

  DynatraceSecretsAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for accessing Dynatrace secrets
      Path: /
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Resource: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
            Action:
              - secretsmanager:GetSecretValue
          - Effect: Allow
            Resource: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
            Action:
              - secretsmanager:GetSecretValue
          - Effect: Allow
            Action:
              - secretsmanager:ListSecrets
            Resource: 'arn:aws:secretsmanager:eu-west-2:216552277552:secret:*'
          - Effect: Allow
            Action:
              - kms:Decrypt
            Resource: 'arn:aws:kms:eu-west-2:216552277552:key/*'

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Ref DeploymentName
      DeletionProtection: !Ref DeletionProtection
      Policies:
        PasswordPolicy:
          MinimumLength: 6
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          TemporaryPasswordValidityDays: 7
      Schema:
        - Name: sub
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: false
          Required: true
          StringAttributeConstraints:
            MinLength: 1
            MaxLength: 2048
        - Name: email
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
        - Name: phone_number
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: 0
            MaxLength: 2048
        - Name: signup_status
          AttributeDataType: String
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
      AutoVerifiedAttributes: [ email ]
      UsernameAttributes: [ email ]
      EmailVerificationMessage: !Sub |-
        <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
            <title>Your security code for the ${ProductName}</title>
            <style>
              body {
                -webkit-font-smoothing: antialiased;
                margin: 0;
                padding: 0;
                -ms-text-size-adjust: 100%;
                -webkit-text-size-adjust: 100%;
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
              }

              .bold-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 700;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .normal-text {
                font-family: Arial;
                font-size: 18px;
                font-weight: 400;
                line-height: 26px;
                letter-spacing: 0px;
                text-align: left;
                color: black;
              }

              .body {
                background-color: #white;
                width: 100%;
              }

              .wrapper {
                box-sizing: border-box;
                padding: 10px;
              }
            </style>
          </head>
          <body>
            <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
              <!--MAIN CONTENT AREA -->
              <tr>
                <td class="wrapper">
                  <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                      <td>
                        <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                          <tbody>
                            <tr>
                              <td width="100%" height="53" bgcolor="#0b0c0c">
                                <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                  <tbody>
                                    <tr>
                                      <td width="70" bgcolor="#0b0c0c" valign="middle">
                                        <a href="https://admin.sign-in.service.gov.uk/services" title="Go to GOV.UK One Login Admin Tool services" style="text-decoration:none" target="_blank">
                                          <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                            <tbody>
                                              <tr>
                                                <td style="padding-left:10px">
                                                  <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                </td>
                                                <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                  <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                  <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                          -moz-osx-font-smoothing: grayscale;
                          display: inline-table;
                          font-style: normal;
                          font-weight: 400;
                          font-size: 24px;
                          line-height: 32px;
                          color: white;
                          "> One Login admin tool <strong style="display: inline-block;
                              outline: 2px solid transparent;
                              outline-offset: -2px;
                              color: #ffffff;
                              background-color: #1d70b8;
                              letter-spacing: 1px;
                              text-decoration: none;
                              text-transform: uppercase;
                              font-family: arial, sans-serif;
                              -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              padding-top: 5px;
                              padding-right: 8px;
                              padding-bottom: 4px;
                              padding-left: 8px;
                              font-style: normal;
                              font-weight: 700;
                              font-size: 16px;
                              line-height: 16px;
                              letter-spacing: 1px;
                              text-transform: uppercase;"> beta </strong>
                                                  </span>
                                                </td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </a>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <div style="margin-top: 40px;"></div>
                        <p class="normal-text">Your security code is: </p>
                        <p class="bold-text">{####}</p>
                        <p class="normal-text">The code will expire after 15 minutes.</p>
                        <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                        <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
        </html>
      EmailVerificationSubject: !Sub Your security code for the ${ProductName}
      VerificationMessageTemplate:
        EmailMessage: !Sub |-
          <html>
            <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
              <title>Your security code for the ${ProductName}</title>
              <style>
                body {
                  -webkit-font-smoothing: antialiased;
                  margin: 0;
                  padding: 0;
                  -ms-text-size-adjust: 100%;
                  -webkit-text-size-adjust: 100%;
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                }

                .bold-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 700;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .normal-text {
                  font-family: Arial;
                  font-size: 18px;
                  font-weight: 400;
                  line-height: 26px;
                  letter-spacing: 0px;
                  text-align: left;
                  color: black;
                }

                .body {
                  background-color: #white;
                  width: 100%;
                }

                .wrapper {
                  box-sizing: border-box;
                  padding: 10px;
                }
              </style>
            </head>
            <body>
              <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                <!--MAIN CONTENT AREA -->
                <tr>
                  <td class="wrapper">
                    <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                      <tr>
                        <td>
                          <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                            <tbody>
                              <tr>
                                <td width="100%" height="53" bgcolor="#0b0c0c">
                                  <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                    <tbody>
                                      <tr>
                                        <td width="70" bgcolor="#0b0c0c" valign="middle">
                                          <a href="https://admin.sign-in.service.gov.uk/services" title="Go to GOV.UK One Login Admin Tool services" style="text-decoration:none" target="_blank">
                                            <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                              <tbody>
                                                <tr>
                                                  <td style="padding-left:10px">
                                                    <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                  </td>
                                                  <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                    <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                    <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                            display: inline-table;
                            font-style: normal;
                            font-weight: 400;
                            font-size: 24px;
                            line-height: 32px;
                            color: white;
                            "> One Login admin tool <strong style="display: inline-block;
                                outline: 2px solid transparent;
                                outline-offset: -2px;
                                color: #ffffff;
                                background-color: #1d70b8;
                                letter-spacing: 1px;
                                text-decoration: none;
                                text-transform: uppercase;
                                font-family: arial, sans-serif;
                                -webkit-font-smoothing: antialiased;
                                -moz-osx-font-smoothing: grayscale;
                                padding-top: 5px;
                                padding-right: 8px;
                                padding-bottom: 4px;
                                padding-left: 8px;
                                font-style: normal;
                                font-weight: 700;
                                font-size: 16px;
                                line-height: 16px;
                                letter-spacing: 1px;
                                text-transform: uppercase;"> beta </strong>
                                                    </span>
                                                  </td>
                                                </tr>
                                              </tbody>
                                            </table>
                                          </a>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                          <div style="margin-top: 40px;"></div>
                          <p class="normal-text">Your security code is: </p>
                          <p class="bold-text">{####}</p>
                          <p class="normal-text">The code will expire after 15 minutes.</p>
                          <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                          <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
          </html>
        EmailSubject: !Sub Your security code for the ${ProductName}
        DefaultEmailOption: CONFIRM_WITH_CODE
      MfaConfiguration: OPTIONAL
      EnabledMfas: [ SMS_MFA ]
      SmsConfiguration:
        SnsCallerArn: !GetAtt SmsRole.Arn
        ExternalId: !Ref ExternalId
        SnsRegion: !Ref AWS::Region
      EmailConfiguration:
        EmailSendingAccount: DEVELOPER
        SourceArn: !ImportValue DNS-EmailIdentityARN
        From: !Sub [ "${EmailSenderID} <${DeploymentName}@${Domain}>", { Domain: !ImportValue DNS-Domain } ]
      # https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-sms-settings.html
      LambdaConfig:
        CustomSMSSender:
          LambdaArn: !GetAtt SendSecurityCodeTextMessageFunction.Arn
          LambdaVersion: V1_0
        KMSKeyID: !GetAtt SecurityCodeEncryptionKey.Arn
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
        InviteMessageTemplate:
          EmailMessage: !Sub |-
            <html>
              <head>
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                <title>Your security code for the ${ProductName}</title>
                <style>
                  body {
                    -webkit-font-smoothing: antialiased;
                    margin: 0;
                    padding: 0;
                    -ms-text-size-adjust: 100%;
                    -webkit-text-size-adjust: 100%;
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                  }

                  .bold-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 700;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .normal-text {
                    font-family: Arial;
                    font-size: 18px;
                    font-weight: 400;
                    line-height: 26px;
                    letter-spacing: 0px;
                    text-align: left;
                    color: black;
                  }

                  .body {
                    background-color: #white;
                    width: 100%;
                  }

                  .wrapper {
                    box-sizing: border-box;
                    padding: 10px;
                  }
                </style>
              </head>
              <body>
                <table role="presentation" border="0" cellpadding="0" cellspacing="0" class="body">
                  <!--MAIN CONTENT AREA -->
                  <tr>
                    <td class="wrapper">
                      <table role="presentation" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                          <td>
                            <table role="presentation" width="100%" style="border-collapse:collapse;min-width:100%;width:100%!important" cellpadding="0" cellspacing="0" border="0">
                              <tbody>
                                <tr>
                                  <td width="830px" height="53" bgcolor="#0b0c0c">
                                    <table role="presentation" width="100%" style="border-collapse:collapse;max-width:580px" cellpadding="0" cellspacing="0" border="0" align="left">
                                      <tbody>
                                        <tr>
                                          <td width="70" bgcolor="#0b0c0c" valign="middle">
                                            <a style="text-decoration:none;pointer-events: none;cursor: default;">
                                              <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse">
                                                <tbody>
                                                  <tr>
                                                    <td style="padding-left:10px">
                                                      <img src="https://ci4.googleusercontent.com/proxy/pvN1p4x4E1j9aX5roof_HW0YpKqWW5iSOZzXLTlAyx0NPYGuqBupZFadY3FPEYjc00W_X_99tYW-5-3Y52Si7-xReAOZTsXAcfafeDRvFFZS_xQvOBKajCUR5L0fvA8=s0-d-e1-ft#https://static.notifications.service.gov.uk/images/gov.uk_logotype_crown.png" alt="" height="32" border="0" style="Margin-top:4px" class="CToWUd">
                                                    </td>
                                                    <td style="font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px">
                                                      <span style="font-family:Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block">GOV.UK</span>
                                                      <span style="font-family: arial, sans-serif; -webkit-font-smoothing: antialiased;
                              -moz-osx-font-smoothing: grayscale;
                              display: inline-table;
                              font-style: normal;
                              font-weight: 400;
                              font-size: 24px;
                              line-height: 32px;
                              color: white;
                              "> One Login admin tool <strong style="display: inline-block;
                                  outline: 2px solid transparent;
                                  outline-offset: -2px;
                                  color: #ffffff;
                                  background-color: #1d70b8;
                                  letter-spacing: 1px;
                                  text-decoration: none;
                                  text-transform: uppercase;
                                  font-family: arial, sans-serif;
                                  -webkit-font-smoothing: antialiased;
                                  -moz-osx-font-smoothing: grayscale;
                                  padding-top: 5px;
                                  padding-right: 8px;
                                  padding-bottom: 4px;
                                  padding-left: 8px;
                                  font-style: normal;
                                  font-weight: 700;
                                  font-size: 16px;
                                  line-height: 16px;
                                  letter-spacing: 1px;
                                  text-transform: uppercase;"> beta </strong>
                                                      </span>
                                                    </td>
                                                  </tr>
                                                </tbody>
                                              </table>
                                            </a>
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                            <div style="margin-top: 40px;"></div>
                            <p class="normal-text">Your security code is: </p>
                            <p class="bold-text">{####}</p>
                            <p class="normal-text">The code will expire after 15 minutes.</p>
                            <p class="normal-text"> It will confirm the email address for your <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">GOV.UK</a> One Login account: </p>
                            <p class="normal-text"> <a style="word-wrap:break-word;color:#1d70b8" href="GOV.UK" target="_blank" data-saferedirecturl="GOV.UK ">{username} </a></p>
                            <p class="normal-text">If you did not use this email address to create an account, you can ignore this email.</p>
                          </span>
                        </tr>
                      </table>
                    </td>
                        </tr>
                      </table>
              </body>
            </html>
          EmailSubject: !Sub Your security code for the ${ProductName}
      UsernameConfiguration:
        CaseSensitive: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Priority: 1
            Name: verified_email

  UserPoolLogDelivery:
    Type: AWS::Cognito::LogDeliveryConfiguration
    Properties:
      LogConfigurations:
        - CloudWatchLogsConfiguration:
            LogGroupArn: !Sub
              - arn:aws:logs:${Region}:${Account}:log-group:${LogGroup}
              - Region: !Ref AWS::Region
                Account: !Ref AWS::AccountId
                LogGroup: !Ref CognitoLogsGroup
          EventSource: userNotification
          LogLevel: ERROR
      UserPoolId: !Ref UserPool

  CognitoLogsGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - "/"
        - - '/aws/cognito'
          - 'onboarding-self-service'
          - !If [ IsLocal, !Ref DeploymentName, !Ref AWS::NoValue ]
          - 'user-pool'
      RetentionInDays: 30
      DataProtectionPolicy:
        Name: data-protection-policy-cognito-lambda
        Description: Data Protection for Cloudwatch Logs
        Version: '2021-06-01'
        Statement:
          - Sid: audit-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Audit:
                FindingsDestination:
                  CloudWatchLogs:
                    LogGroup: !Ref LogAuditLogGroup
          - Sid: redact-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Deidentify:
                MaskConfig: { }

  CognitoLogCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsLoggingEnabled
    Properties:
      LogGroupName: !Ref CognitoLogsGroup
      FilterName: "Cognito error logs"
      FilterPattern: ""
      DestinationArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment, clslSubscriptionFilterArn ]

  # https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-sms-settings.html
  SmsRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service: cognito-idp.amazonaws.com
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalId
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*
      Policies:
        - PolicyName: SnsPublish
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              Effect: Allow
              Action: "sns:Publish"
              Resource: "*"

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  SendSecurityCodeTextMessageFunctionPermission:
    Type: AWS::Lambda::Permission
    # checkov:skip=CKV_AWS_364: Ensure that AWS Lambda function permissions delegated to AWS services are limited by SourceArn or SourceAccount
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SendSecurityCodeTextMessageFunction
      Principal: cognito-idp.amazonaws.com

  CognitoWebACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      WebACLArn: !Sub
        - "{{resolve:ssm:${WafArnParam}}}"
        - WafArnParam: !FindInMap [ WafArn, Environment, !Ref Environment ]
      ResourceArn: !GetAtt UserPool.Arn

Outputs:
  UserPoolID:
    Value: !Ref UserPool
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolID
  UserPoolARN:
    Value: !GetAtt UserPool.Arn
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolARN
  UserPoolClientID:
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${DeploymentName}-Cognito-UserPoolClientID
