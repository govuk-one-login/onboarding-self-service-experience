AWSTemplateFormatVersion: "2010-09-09"
Description: DI Self-Service API
Transform: [ AWS::LanguageExtensions, AWS::Serverless-2016-10-31 ]

Parameters:
  ClientRegistryEndpoint:
    Type: String
    Default: https://oidc.integration.account.gov.uk
    Description: Auth client registration endpoint
  NotificationEmail:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/api/notifications-email
    Description: Email address to send internal notifications
  LogGroupPrefix:
    Type: String
    AllowedPattern: ^.*[^\/]$
    Default: /aws/vendedlogs
  DeploymentName:
    Type: String
    MaxLength: 28
    AllowedPattern: ^.*[^-]$
    Default: self-service
    Description: A unique prefix to identify the deployment; used when importing or exporting values from related stacks
  PrivateAPI:
    Type: String
    AllowedValues: [ Yes, No ]
    Default: Yes
  PermissionsBoundary:
    Type: String
    Default: ""
  CodeSigningConfigArn:
    Type: String
    Default: ""

Conditions:
  PrivateAPI: !Equals [ !Ref PrivateAPI, Yes ]
  UseCodeSigning: !Not [ !Equals [ !Ref CodeSigningConfigArn, "" ] ]
  UsePermissionsBoundary: !Not [ !Equals [ !Ref PermissionsBoundary, "" ] ]

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
    VpcConfig:
      SecurityGroupIds: [ !ImportValue VPC-VPCEndpointsSecurityGroup ]
      SubnetIds: !Split [ ",", !ImportValue VPC-PrivateSubnets ]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps

Resources:
  # https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-private-apis.html
  API:
    # checkov:skip=CKV_AWS_120:Ensure API Gateway caching is enabled
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ${DeploymentName}-api
      StageName: self-service-api
      TracingEnabled: true
      FailOnWarnings: true
      OpenApiVersion: 3.0.1
      Auth:
        ResourcePolicy: !If
          - PrivateAPI
          - # https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies-examples.html#apigateway-resource-policies-source-vpc-example
            CustomStatements:
              - Effect: Allow
                Resource: execute-api:/*
                Action: execute-api:Invoke
                Principal: "*"
                Condition:
                  StringEquals:
                    aws:SourceVpce:
                      Fn::ImportValue: VPC-ExecuteAPIGatewayEndpointID
          - !Ref AWS::NoValue
      EndpointConfiguration:
        Type: !If [ PrivateAPI, PRIVATE, !Ref AWS::NoValue ]
        VpcEndpointIds: !If [ PrivateAPI, [ Fn::ImportValue: VPC-ExecuteAPIGatewayEndpointID ], !Ref AWS::NoValue ]
      MethodSettings:
        - HttpMethod: "*"
          ResourcePath: /*
          LoggingLevel: INFO
          MetricsEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt APIAccessLogsGroup.Arn
        Format:
          Fn::ToJsonString:
            path: $context.path
            status: $context.status
            protocol: $context.protocol
            routeKey: $context.routeKey
            requestId: $context.requestId
            requestTime: $context.requestTime
            httpMethod: $context.httpMethod
            responseLength: $context.responseLength
            extendedRequestId: $context.extendedRequestId

  LogAuditLogGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${LogGroupPrefix}/${DeploymentName}/api/audit
      RetentionInDays: 14

  APIAccessLogsGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${LogGroupPrefix}/${DeploymentName}/api
      RetentionInDays: 14
      DataProtectionPolicy:
        Name: data-protection-policy
        Description: Data Protection for Cloudwatch Logs
        Version: '2021-06-01'
        Statement:
          - Sid: audit-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Audit:
                FindingsDestination:
                  CloudWatchLogs:
                    LogGroup: !Sub ${LogGroupPrefix}/${DeploymentName}/api/audit
          - Sid: redact-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Deidentify:
                MaskConfig: { }
  #--- Users ---#

  EnvironmentVariablesEncryptionKey:
    # checkov:skip=CKV_AWS_7:Ensure rotation for customer created CMKs is enabled
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Resource: "*"
            Action: kms:*
            Principal:
              AWS: !Ref AWS::AccountId
          - Effect: Allow
            Resource: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*
            Action:
              - kms:ListAliases
              - kms:CreateGrant
              - kms:Encrypt
              - kms:Decrypt
            Principal:
              Service: lambda.amazonaws.com
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function/*

  GetUserFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-user.getUserHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /get-user
            Method: POST

  PutUserFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-user.putUserHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /put-user
            Method: POST

  UpdateUserFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/update-user.updateUserHandler
      Description: Updates user data in DynamoDB
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /update-user
            Method: POST

  #--- Services ---#

  GetServicesFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-services.getServicesHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /get-services/{userId}
            Method: GET

  GetSessionCountFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-session-count.getSessionCountHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-SessionsTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-SessionsTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /get-session-count/{userEmail}
            Method: GET

  GlobalSignOutFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/global-sign-out.globalSignOutHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-SessionsTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-SessionsTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /global-sign-out/{userEmail}
            Method: GET

  PutServiceFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service.putServiceHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName

  #--- Service clients ---#

  GetServiceClientsFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-service-clients.getServiceClientsHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBReadPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /get-service-clients/{serviceId}
            Method: GET

  PutServiceClientFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service-client.putServiceClientHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName

  UpdateServiceClientFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/update-service-client.updateServiceClientHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName

  #--- Service users ---#

  PutServiceUserFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service-user.putServiceUserHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - DynamoDBWritePolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName

  #--- Auth clients ---#

  RegisterAuthClientFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Description: Assumes a cross-account role and invokes the Auth register Lambda
      Handler: backend/api/src/handlers/auth/register-client.registerClientHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies: [ AWSLambdaVPCAccessExecutionRole, AWSXrayWriteOnlyAccess ]
      VpcConfig:
        SubnetIds: !Split [ ",", !ImportValue VPC-ProtectedSubnets ]
      Environment:
        Variables:
          AUTH_REGISTRATION_BASE_URL: !Ref ClientRegistryEndpoint
          AUTH_API_KEY: "{{resolve:secretsmanager:/self-service/api/client-registry-api-key}}"
      KmsKeyArn: !GetAtt EnvironmentVariablesEncryptionKey.Arn

  UpdateAuthClientFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Description: Updates a client using an HTTP endpoint
      Handler: backend/api/src/handlers/auth/update-client.updateClientInRegistryHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies: [ AWSLambdaVPCAccessExecutionRole, AWSXrayWriteOnlyAccess ]
      VpcConfig:
        SubnetIds: !Split [ ",", !ImportValue VPC-ProtectedSubnets ]
      Environment:
        Variables:
          AUTH_REGISTRATION_BASE_URL: !Ref ClientRegistryEndpoint
          AUTH_API_KEY: "{{resolve:secretsmanager:/self-service/api/client-registry-api-key}}"
      KmsKeyArn: !GetAtt EnvironmentVariablesEncryptionKey.Arn

  #--- Step Functions ---#

  NewServiceHandler:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/new-service.newServiceHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: states:StartSyncExecution
              Resource: !Ref NewServiceStepFunction
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref NewServiceStepFunction
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /new-service
            Method: POST

  NewClientHandler:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/new-client.newClientHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: states:StartSyncExecution
              Resource: !Ref NewClientStepFunction
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref NewClientStepFunction
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /new-client
            Method: POST

  UpdateClientHandler:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/update-client.doUpdateClientHandler
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSLambdaVPCAccessExecutionRole
        - AWSXrayWriteOnlyAccess
        - Version: 2012-10-17
          Statement:
            - Effect: Allow
              Action: states:StartSyncExecution
              Resource: !Ref UpdateClientStepFunction
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref UpdateClientStepFunction
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /update-client
            Method: POST

  UpdateServiceHandler:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/update-service.updateServiceHandler
      Description: Updates service data in DynamoDB
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSXrayWriteOnlyAccess
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Environment:
        Variables:
          TABLE:
            Fn::ImportValue: !Sub ${DeploymentName}-DynamoDB-DataTableName
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /update-service
            Method: POST

  KMSDecryptAccessPolicy:
    # checkov:skip=CKV_AWS_111:Ensure IAM policies does not allow write access without constraints
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for decrypting KMS
      Path: /
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - kms:GenerateDataKey
              - kms:Decrypt
            Resource: "*"

  SendSQSMessageToTxMAHandler:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/logging/sqs-service.sendSQSMessageToTxMAHandler
      Description: Sends a message to the TxMA SQS
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Policies: [ AWSLambdaVPCAccessExecutionRole, AmazonSQSFullAccess, !Ref KMSDecryptAccessPolicy ]
      Environment:
        Variables:
          QUEUEURL: !Join [ '', [!Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/', !Join ["frontend", !Split ["api", !Sub '${AWS::StackName}' ] ], "-AuditEventQueue"]]
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /txma-logging
            Method: POST

  StepFunctionExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub states.${AWS::Region}.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StepFunctionExecution
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${StepFunctionsLogGroup}
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource:
                  - !GetAtt PutServiceFunction.Arn
                  - !GetAtt PutServiceUserFunction.Arn
                  - !GetAtt PutServiceClientFunction.Arn
                  - !GetAtt UpdateServiceClientFunction.Arn
                  - !GetAtt RegisterAuthClientFunction.Arn
                  - !GetAtt UpdateAuthClientFunction.Arn
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                  - xray:GetSamplingRules
                  - xray:GetSamplingTargets
                Resource: "*"

  NewServiceStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/new-service.json
      DefinitionSubstitutions:
        PutServiceFunctionArn: !GetAtt PutServiceFunction.Arn
        PutServiceUserFunctionArn: !GetAtt PutServiceUserFunction.Arn
      Tracing:
        Enabled: true

  NewClientStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/new-client.json
      DefinitionSubstitutions:
        RegisterClientFunctionArn: !GetAtt RegisterAuthClientFunction.Arn
        PutServiceClientFunctionArn: !GetAtt PutServiceClientFunction.Arn
      Tracing:
        Enabled: true

  UpdateClientStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/update-client.json
      DefinitionSubstitutions:
        UpdateClientInRegistryFunctionArn: !GetAtt UpdateAuthClientFunction.Arn
        UpdateServiceClientFunctionArn: !GetAtt UpdateServiceClientFunction.Arn
      Tracing:
        Enabled: true

  StepFunctionsLogGroup:
    # checkov:skip=CKV_AWS_158:Ensure that CloudWatch Log Group is encrypted by KMS
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${LogGroupPrefix}/${DeploymentName}/api/step-functions
      RetentionInDays: 14
      DataProtectionPolicy:
        Name: data-protection-policy
        Description: Data Protection for Cloudwatch Logs
        Version: '2021-06-01'
        Statement:
          - Sid: audit-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Audit:
                FindingsDestination:
                  CloudWatchLogs:
                    LogGroup: !Sub ${LogGroupPrefix}/${DeploymentName}/api/audit
          - Sid: redact-policy
            DataIdentifier:
              - arn:aws:dataprotection::aws:data-identifier/EmailAddress
              - arn:aws:dataprotection::aws:data-identifier/IpAddress
              - arn:aws:dataprotection::aws:data-identifier/Address
              - arn:aws:dataprotection::aws:data-identifier/AwsSecretKey
              - arn:aws:dataprotection::aws:data-identifier/OpenSshPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PgpPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PkcsPrivateKey
              - arn:aws:dataprotection::aws:data-identifier/PuttyPrivateKey
            Operation:
              Deidentify:
                MaskConfig: { }

  #--- Notifications ---#

  PublicBetaNotificationFunction:
    # checkov:skip=CKV_AWS_115:Ensure that AWS Lambda function is configured for function-level concurrent execution limit
    # checkov:skip=CKV_AWS_117:Ensure that AWS Lambda function is configured inside a VPC
    # checkov:skip=CKV_AWS_116:Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
    # checkov:skip=CKV_AWS_173:Check encryption settings for Lambda environmental variable
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/notifications/send-public-beta-notification.publicBetaRequestHandler
      Description: Publish a message to the public beta request notification topic
      CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Tracing: Active
      Policies:
        - AWSXrayWriteOnlyAccess
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationsSnsTopic.TopicName
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref NotificationsSnsTopic
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref API
            Path: /send-public-beta-request-notification
            Method: POST

  NotificationsSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: DI Admin Tool Internal
      TopicName: !Sub ${DeploymentName}-internal-notifications
      KmsMasterKeyId: alias/aws/sns
      Subscription:
        - Protocol: email
          Endpoint: !Ref NotificationEmail

Outputs:
  # SAM Serverless Function implicit API resources | Invoking private APIs
  # https://github.com/aws/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  # https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-private-api-test-invoke-url.html#apigateway-private-api-route53-alias
  APIBaseURL:
    Value: !Sub
      - https://${EndpointID}.execute-api.${AWS::Region}.amazonaws.com/${API.Stage}
      - EndpointID: !Join
          - "-"
          - - !Ref API
            - !If [ PrivateAPI, Fn::ImportValue: VPC-ExecuteAPIGatewayEndpointID, !Ref AWS::NoValue ]
    Export:
      Name: !Sub ${DeploymentName}-API-BaseURL
