AWSTemplateFormatVersion: "2010-09-09"
Description: DI self-service API
Transform: AWS::Serverless-2016-10-31

Parameters:
  AuthRegistrationBaseUrl:
    Type: String
    Default: https://oidc.integration.account.gov.uk
    Description: API Gateway endpoint for client registration
  NotificationEmail:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /self-service/config/api/notification-email
    Description: Email address to send internal notifications
  LogGroupNamePrefix:
    Type: String
    Default: /aws/vendedlogs
  PermissionsBoundary:
    Type: String
    Default: ""
    Description: The ARN of the permissions boundary to apply when creating IAM roles [Secure Pipeline]
  CodeSigningConfigArn:
    Type: String
    Default: ""
    Description: The ARN of the code signing configuration resource to use [Secure Pipeline]

Conditions:
  UseCodeSigning: !Not [ !Equals [ !Ref CodeSigningConfigArn, "" ] ]
  UsePermissionsBoundary: !Not [ !Equals [ !Ref PermissionsBoundary, "" ] ]

Globals:
  Function:
    Timeout: 100
    Runtime: nodejs18.x
    CodeSigningConfigArn: !If [ UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
    PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps

Resources:

  SelfServiceApi:
    # checkov:skip=CKV_AWS_95: "Ensure API Gateway V2 has Access Logging enabled"
    Type: AWS::Serverless::HttpApi
    Properties:
      FailOnWarnings: true
      StageName: self-service-api

  #--- Users ---#

  GetUserFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-user.getUserHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /get-user
            Method: POST

  PutUserFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-user.putUserHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /put-user
            Method: POST

  UpdateUserFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/update-user.updateUserHandler
      Description: Updates user data in DynamoDB (without touching Cognito)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /update-user
            Method: POST

  #--- Services ---#

  GetServicesFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-services.getServicesHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /get-services/{userId}
            Method: GET

  PutServiceFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service.putServiceHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable

  #--- Service clients ---#

  GetServiceClientsFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/get-service-clients.getServiceClientsHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /get-service-clients/{serviceId}
            Method: GET

  PutServiceClientFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service-client.putServiceClientHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable

  UpdateServiceClientFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/update-service-client.updateServiceClientHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable

  #--- Service users ---#

  PutServiceUserFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/dynamodb/put-service-user.putServiceUserHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !ImportValue AdminToolDataTable
      Environment:
        Variables:
          TABLE: !ImportValue AdminToolDataTable

  #--- Auth clients ---#

  RegisterAuthClientFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/auth/register-client.registerClientHandler
      Description: Assumes a cross-account role and invokes the Auth register lambda
      Environment:
        Variables:
          AUTH_REGISTRATION_BASE_URL: !Ref AuthRegistrationBaseUrl
          AUTH_API_KEY: "{{resolve:ssm:/self-service/api/auth-api-key}}"

  UpdateAuthClientFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/auth/update-client.updateClientInRegistryHandler
      Description: Updates a client using an HTTP endpoint
      Environment:
        Variables:
          AUTH_REGISTRATION_BASE_URL: !Ref AuthRegistrationBaseUrl
          AUTH_API_KEY: "{{resolve:ssm:/self-service/api/auth-api-key}}"

  #--- Step Functions ---#

  NewServiceHandler:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/new-service.newServiceHandler
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref NewServiceStepFunction
      Policies:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: states:StartSyncExecution
            Resource: !Ref NewServiceStepFunction
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /new-service
            Method: POST

  NewClientHandler:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/new-client.newClientHandler
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref NewClientStepFunction
      Policies:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: states:StartSyncExecution
            Resource: !Ref NewClientStepFunction
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /new-client
            Method: POST

  UpdateClientHandler:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/step-functions/update-client.doUpdateClientHandler
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref UpdateClientStepFunction
      Policies:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: states:StartSyncExecution
            Resource: !Ref UpdateClientStepFunction
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /update-client
            Method: POST

  StepFunctionExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub states.${AWS::Region}.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StepFunctionExecutionPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${StepFunctionsLogGroup}
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource:
                  - !GetAtt PutServiceFunction.Arn
                  - !GetAtt PutServiceUserFunction.Arn
                  - !GetAtt PutServiceClientFunction.Arn
                  - !GetAtt UpdateServiceClientFunction.Arn
                  - !GetAtt RegisterAuthClientFunction.Arn
                  - !GetAtt UpdateAuthClientFunction.Arn

  NewServiceStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/new-service.json
      DefinitionSubstitutions:
        PutServiceFunctionArn: !GetAtt PutServiceFunction.Arn
        PutServiceUserFunctionArn: !GetAtt PutServiceUserFunction.Arn

  NewClientStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/new-client.json
      DefinitionSubstitutions:
        RegisterClientFunctionArn: !GetAtt RegisterAuthClientFunction.Arn
        PutServiceClientFunctionArn: !GetAtt PutServiceClientFunction.Arn

  UpdateClientStepFunction:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      Role: !GetAtt StepFunctionExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: True
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
      DefinitionUri: state-machines/update-client.json
      DefinitionSubstitutions:
        UpdateClientInRegistryFunctionArn: !GetAtt UpdateAuthClientFunction.Arn
        UpdateServiceClientFunctionArn: !GetAtt UpdateServiceClientFunction.Arn

  StepFunctionsLogGroup:
    # checkov:skip=CKV_AWS_158: "Ensure that CloudWatch Log Group is encrypted by KMS"
    # checkov:skip=CKV_AWS_66: "Ensure that CloudWatch Log Group specifies retention days"
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${LogGroupNamePrefix}/states/${AWS::StackName}

  #--- Notifications ---#

  PrivateBetaNotificationFunction:
    # checkov:skip=CKV_AWS_115: "Ensure that AWS Lambda function is configured for function-level concurrent execution limit"
    # checkov:skip=CKV_AWS_117: "Ensure that AWS Lambda function is configured inside a VPC"
    # checkov:skip=CKV_AWS_116: "Ensure that AWS Lambda function is configured for a Dead Letter Queue(DLQ)"
    # checkov:skip=CKV_AWS_173: "Check encryption settings for Lambda environmental variable"
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: backend/api/src/handlers/notifications/send-private-beta-notification.privateBetaRequestHandler
      Description: Publish a message to the private beta request notification topic
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref NotificationsSnsTopic
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt NotificationsSnsTopic.TopicName
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref SelfServiceApi
            Path: /send-private-beta-request-notification
            Method: POST

  NotificationsSnsTopic:
    # checkov:skip=CKV_AWS_26: "Ensure all data stored in the SNS topic is encrypted"
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: DI Admin Tool
      Subscription:
        - Protocol: email
          Endpoint: !Ref NotificationEmail

Outputs:
  # SAM Serverless Function implicit API resources
  # https://github.com/aws/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  SelfServiceApiBaseUrl:
    Description: API Gateway base URL of the self-service backend endpoints
    Value: !Sub ${SelfServiceApi.ApiEndpoint}/${SelfServiceApi.Stage}
