AWSTemplateFormatVersion: "2010-09-09"
Description: Admin Tool VPC and networking components to provide security controls and public access to the app

Parameters:
  # ADR in review https://github.com/alphagov/digital-identity-architecture/pull/491
  InternetSubnets:
    Type: List<String>
    Default: ""
    Description: Temporary param to export the firewall subnet IDs until they're exported from the VPC stack
  ExportPrefix:
    Type: String
    AllowedPattern: ^.*[^-]$
    Default: VPC
  TemplateStorageBucket:
    Type: String
    Default: https://template-storage-templatebucket-1upzyw6v9cs42.s3.amazonaws.com

Resources:
  VPC:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub ${TemplateStorageBucket}/vpc/template.yaml
      Parameters:
        ECRApiEnabled: "Yes"
        KMSApiEnabled: "Yes"
        LogsApiEnabled: "Yes"
        DynamoDBApiEnabled: "Yes"
        ExecuteApiGatewayEnabled: "Yes"
        AccessLogsCustomBucketNameEnabled: "No"
        AvailabilityZoneCount: 2
        AllowedDomains: !Join [ ",", [
          !Sub "cognito-idp.${AWS::Region}.amazonaws.com",
          api.notifications.service.gov.uk,
          "*.cloudfront.net"
        ] ]
        AllowRules: !Sub >
          pass tls $HOME_NET any -> $EXTERNAL_NET 443 (tls.sni; content:"cognito-idp.${AWS::Region}.amazonaws.com";
          startswith; endswith; msg:"Pass TLS to Cognito"; flow:established; rev:1; sid:2001;)
          
          pass tls $HOME_NET any -> $EXTERNAL_NET 443 (tls.sni; content:"api.notifications.service.gov.uk";
          startswith; endswith; msg:"Pass TLS to Notify API"; flow:established; rev:1; sid:2002;)
          
          pass tls $HOME_NET any -> $EXTERNAL_NET 443 (tls.sni; content:".cloudfront.net";
          endswith; msg:"Pass TLS to CloudFront"; flow:established; rev:1; sid:2003;)

Outputs:
  VPCID:
    Value: !GetAtt VPC.Outputs.VpcId
    Export:
      Name: !Sub ${ExportPrefix}-ID
  VPCStackName:
    Value: !Select [ 1, !Split [ "/", !Ref VPC ] ]
    Export:
      Name: !Sub ${ExportPrefix}-StackName
  PrivateSubnets:
    Value: !Join [ ",", [ !GetAtt VPC.Outputs.PrivateSubnetIdA, !GetAtt VPC.Outputs.PrivateSubnetIdB ] ]
    Export:
      Name: !Sub ${ExportPrefix}-PrivateSubnets
  ProtectedSubnets:
    Value: !Join [ ",", [ !GetAtt VPC.Outputs.ProtectedSubnetIdA, !GetAtt VPC.Outputs.ProtectedSubnetIdB ] ]
    Export:
      Name: !Sub ${ExportPrefix}-ProtectedSubnets
  InternetSubnets:
    Value: !Join [ ",", !Ref InternetSubnets ]
    Export:
      Name: !Sub ${ExportPrefix}-InternetSubnets
  ExecuteAPIGatewayVPCEndpointID:
    Value: !GetAtt VPC.Outputs.ExecuteApiGatewayVpcEndpointId
    Export:
      Name: !Sub ${ExportPrefix}-ExecuteAPIGatewayEndpointID
  VPCEndpointsSecurityGroupID:
    Value: !GetAtt VPC.Outputs.AWSServicesEndpointSecurityGroupId
    Export:
      Name: !Sub ${ExportPrefix}-EndpointsSecurityGroupID
